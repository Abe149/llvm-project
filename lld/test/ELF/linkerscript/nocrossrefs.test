# REQUIRES: x86
# RUN: rm -rf %t && split-file %s %t && cd %t

# RUN: llvm-mc --triple=x86_64 -filetype=obj a.s -o a.o
# RUN: llvm-mc --triple=x86_64 -filetype=obj data.s -o data.o
# RUN: ld.lld a.o data.o -T 0.t

# RUN: not ld.lld a.o data.o -T 1.t 2>&1 | FileCheck %s --check-prefix=ERR1 --implicit-check-not=error:
# ERR1:      error: a.o:(.text.start+0x11): prohibited cross reference from '.text' to 'data' in '.data'

## .text and .text1 are in two NOCROSSREFS commands. Violations are reported twice.
# RUN: not ld.lld --threads=1 a.o data.o -T 2.t 2>&1 | FileCheck %s --check-prefix=ERR2 --implicit-check-not=error:
# ERR2:      error: a.o:(.text.start+0x6): prohibited cross reference from '.text' to '.text1' in '.text1'
# ERR2-NEXT: error: a.o:(.text.start+0x6): prohibited cross reference from '.text' to '.text1' in '.text1'
# ERR2-NEXT: error: a.o:(.text.start+0xb): prohibited cross reference from '.text' to 'foo2' in '.text2'
# ERR2-NEXT: error: a.o:(.text.start+0x11): prohibited cross reference from '.text' to 'data' in '.data'
# ERR2-NEXT: error: a.o:(.text.start+0x17): prohibited cross reference from '.text' to 'str1' in '.rodata'
## .data occurs twice in the command, but the violation is only reported once.
# ERR2-NEXT: error: a.o:(.text1+0x1): prohibited cross reference from '.text1' to '_edata' in '.data'
# ERR2-NEXT: error: a.o:(.nonalloc+0x0): prohibited cross reference from '.nonalloc' to '.text' in '.text'
# ERR2-NEXT: error: a.o:(.nonalloc+0x10): prohibited cross reference from '.nonalloc' to 'data' in '.data'

# RUN: not ld.lld a.o data.o -T 3.t 2>&1 | FileCheck %s --check-prefix=ERR3 --implicit-check-not=error:
# ERR3:      error: a.o:(.nonalloc+0x0): prohibited cross reference from '.nonalloc' to '.text' in '.text'

#--- 0.t
## Some cases that do not cause errors.
abs = 42;
NOCROSSREFS();
NOCROSSREFS(.text);
NOCROSSREFS( .text .text3 );
NOCROSSREFS_TO(.text .text2 .text3 .data );
NOCROSSREFS_TO(.data .text2 .text3);

#--- 1.t
abs = 42;
NOCROSSREFS(.text .data);

#--- 2.t
abs = 42;
NOCROSSREFS(.text .text1 .text .text1);
NOCROSSREFS(.text .text1 .text2 .data .rodata .data .nonalloc);

#--- 3.t
abs = 42;
NOCROSSREFS_TO(.text .text1 .text2 .data .nonalloc);

#--- a.s
.global _start, foo1, foo2, foo3
.section .text.start,"ax"
_start:
  call _start
  call .text1
  call foo2
  movl data(%rip), %eax
  movl str1(%rip), %eax

.section .text1,"ax"
foo1:
  call _edata

.section .text2,"ax"
foo2:
  call foo3

.section .text3,"ax"
foo3:
  call foo2

.section .rodata.str1.1,"aMS",@progbits,1
str1:
  .asciz "abc"

.section .nonalloc,""
  .quad .text
  .quad .text3
  .quad data

#--- data.s
.section .data,"aw"
.globl data
data:
  .byte 0
  .quad abs
